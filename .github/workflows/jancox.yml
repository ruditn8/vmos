name: VMess Server + Cloudflare Tunnel

on:
  workflow_dispatch:
    inputs:
      uuid:
        description: 'VMess UUID (kosongkan untuk auto-generate)'
        required: false
        default: ''
      ws_path:
        description: 'WebSocket Path'
        required: false
        default: '/vmess'
      keep_alive_hours:
        description: 'Durasi server aktif (jam, max 6)'
        required: false
        default: '6'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'

jobs:
  vmess-tunnel:
    name: ðŸš€ VMess + CF Tunnel
    runs-on: ubuntu-latest
    timeout-minutes: 360  # Max 6 jam

    steps:
      # ============================================
      # STEP 1: Setup Variables
      # ============================================
      - name: ðŸ“‹ Setup Variables
        id: vars
        run: |
          if [ -z "${{ github.event.inputs.uuid }}" ]; then
            UUID=$(cat /proc/sys/kernel/random/uuid)
          else
            UUID="${{ github.event.inputs.uuid }}"
          fi

          WS_PATH="${{ github.event.inputs.ws_path }}"
          if [ -z "$WS_PATH" ]; then
            WS_PATH="/vmess"
          fi

          echo "UUID=${UUID}" >> $GITHUB_OUTPUT
          echo "PORT=8080" >> $GITHUB_OUTPUT
          echo "WS_PATH=${WS_PATH}" >> $GITHUB_OUTPUT

          echo "âœ… UUID       : ${UUID}"
          echo "âœ… Port       : 8080"
          echo "âœ… WS Path    : ${WS_PATH}"

      # ============================================
      # STEP 2: Install Xray-core
      # ============================================
      - name: ðŸ“¦ Install Xray-core
        run: |
          echo "â³ Downloading Xray-core..."
          LATEST=$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases/latest | grep tag_name | cut -d '"' -f 4)
          echo "   Version: ${LATEST}"

          wget -q "https://github.com/XTLS/Xray-core/releases/download/${LATEST}/Xray-linux-64.zip" -O xray.zip

          sudo mkdir -p /usr/local/xray
          sudo unzip -oq xray.zip -d /usr/local/xray
          sudo chmod +x /usr/local/xray/xray

          /usr/local/xray/xray version
          echo "âœ… Xray-core installed successfully"

      # ============================================
      # STEP 3: Configure Xray VMess + WebSocket
      # ============================================
      - name: âš™ï¸ Configure Xray VMess + WebSocket
        run: |
          sudo tee /usr/local/xray/config.json > /dev/null <<EOF
{
  "log": {
    "loglevel": "warning",
    "access": "/tmp/xray-access.log",
    "error": "/tmp/xray-error.log"
  },
  "inbounds": [
    {
      "listen": "127.0.0.1",
      "port": 8080,
      "protocol": "vmess",
      "settings": {
        "clients": [
          {
            "id": "${{ steps.vars.outputs.UUID }}",
            "alterId": 0,
            "security": "auto"
          }
        ]
      },
      "streamSettings": {
        "network": "ws",
        "wsSettings": {
          "path": "${{ steps.vars.outputs.WS_PATH }}",
          "headers": {
            "Host": ""
          }
        }
      },
      "sniffing": {
        "enabled": true,
        "destOverride": ["http", "tls"]
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom",
      "tag": "direct"
    },
    {
      "protocol": "blackhole",
      "tag": "blocked"
    }
  ],
  "routing": {
    "rules": [
      {
        "type": "field",
        "ip": ["geoip:private"],
        "outboundTag": "direct"
      }
    ]
  }
}
EOF
          echo "âœ… Xray configuration created"
          echo "ðŸ“„ Config:"
          cat /usr/local/xray/config.json

      # ============================================
      # STEP 4: Start Xray Server
      # ============================================
      - name: ðŸŸ¢ Start Xray Server
        run: |
          echo "â³ Starting Xray server..."
          nohup /usr/local/xray/xray run -config /usr/local/xray/config.json > /tmp/xray.log 2>&1 &
          XRAY_PID=$!
          echo "XRAY_PID=${XRAY_PID}" >> $GITHUB_ENV

          sleep 3

          # Verify Xray is running
          if kill -0 $XRAY_PID 2>/dev/null; then
            echo "âœ… Xray started successfully (PID: ${XRAY_PID})"
          else
            echo "âŒ Xray failed to start!"
            cat /tmp/xray.log
            cat /tmp/xray-error.log 2>/dev/null
            exit 1
          fi

          # Test port
          if ss -tlnp | grep -q "${{ steps.vars.outputs.PORT }}"; then
            echo "âœ… Port ${{ steps.vars.outputs.PORT }} is listening"
          else
            echo "âŒ Port ${{ steps.vars.outputs.PORT }} is NOT listening"
            ss -tlnp
            exit 1
          fi

      # ============================================
      # STEP 5: Install Cloudflared
      # ============================================
      - name: ðŸ“¦ Install Cloudflared
        run: |
          echo "â³ Installing cloudflared..."
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb -O cloudflared.deb
          sudo dpkg -i cloudflared.deb
          cloudflared version
          echo "âœ… Cloudflared installed successfully"

      # ============================================
      # STEP 6: Start Cloudflare Quick Tunnel
      # ============================================
      - name: ðŸŒ Start Cloudflare Quick Tunnel
        id: tunnel
        run: |
          echo "â³ Starting Cloudflare Quick Tunnel..."

          # Start cloudflared tunnel
          nohup cloudflared tunnel \
            --url http://127.0.0.1:${{ steps.vars.outputs.PORT }} \
            --no-autoupdate \
            --edge-ip-version auto \
            --protocol quic \
            > /tmp/cloudflared.log 2>&1 &

          CF_PID=$!
          echo "CF_PID=${CF_PID}" >> $GITHUB_ENV

          # Wait and extract tunnel URL
          echo "â³ Waiting for tunnel URL..."
          MAX_WAIT=30
          COUNTER=0
          TUNNEL_URL=""

          while [ $COUNTER -lt $MAX_WAIT ]; do
            TUNNEL_URL=$(grep -oP 'https://[a-zA-Z0-9_-]+\.trycloudflare\.com' /tmp/cloudflared.log 2>/dev/null | head -1)
            if [ -n "$TUNNEL_URL" ]; then
              break
            fi
            sleep 2
            COUNTER=$((COUNTER + 2))
            echo "   Waiting... (${COUNTER}s)"
          done

          if [ -z "$TUNNEL_URL" ]; then
            echo "âŒ Failed to get tunnel URL!"
            cat /tmp/cloudflared.log
            exit 1
          fi

          TUNNEL_HOST=$(echo "$TUNNEL_URL" | sed 's|https://||')

          echo "TUNNEL_URL=${TUNNEL_URL}" >> $GITHUB_ENV
          echo "TUNNEL_HOST=${TUNNEL_HOST}" >> $GITHUB_ENV
          echo "TUNNEL_URL=${TUNNEL_URL}" >> $GITHUB_OUTPUT
          echo "TUNNEL_HOST=${TUNNEL_HOST}" >> $GITHUB_OUTPUT

          echo "âœ… Tunnel URL: ${TUNNEL_URL}"

      # ============================================
      # STEP 7: Generate VMess Client Config & Link
      # ============================================
      - name: ðŸ“± Generate VMess Link & Config
        run: |
          UUID="${{ steps.vars.outputs.UUID }}"
          HOST
